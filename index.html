<!doctype html>
<html>
    <head>
        <title>gunfp: Decentralized "Facility Planning" Software</title>

        <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/gun/gun.js" type="text/javascript" charset="utf-8"></script>
        <script src=" https://cdn.jsdelivr.net/npm/paper@0.12.18/dist/paper-full.min.js "></script>

        <link href="https://fonts.googleapis.com/css2?family=Bungee+Tint&family=Fira+Sans:wght@300;500&display=swap" rel="stylesheet">

        <style>
            body,
            html {
                max-width: 100vw;
            }

            .bungee {
                font-family: "Bungee Tint", sans-serif;
                font-weight: 400;
                font-style: normal;
            }

            .fira-sans-light {
                font-family: "Fira Sans", sans-serif;
                font-weight: 300;
                font-style: normal;
            }

            .fira-sans-medium {
                font-family: "Fira Sans", sans-serif;
                font-weight: 600;
                font-style: normal;
            }
        </style>
    </head>

    <body>
        <main 
            id="app"
            classs="max-w-screen"
        >
            <div class="px-20 py-12 flex flex-col space-y-4">
                <div>
                    <h1 class="text-3xl"> 
                        <span class="bungee">wira-pratama/GUNFP:</span>
                        <span class="fira-sans-light pl-2">Activity Relationship Chart Made Easy</span>
                        
                    </h1>
                    <p class="firsa-sans-light pt-2 text-sm">
                        GUNFP is a decentralized single file app created to aid in creating facility planning diagrams collaboratively 
                    </p>
                    <p class="pt-1 text-xs firsa-sans-light text-gray-500">
                        Created by wira-pratama
                    </p>
                    
                </div>
                
                <div>
                    <h2 class="fira-sans-medium text-base">Manage Activities</h2>
                    <p class="firsa-sans-light py-1 text-xs">
                        This is where you create and set relations and reasons for your activities.
                    </p>
                    <div 
                        class=""
                    >
                        <input
                            type="text"
                            placeholder="Activity name" 
                            v-model="newActivity.pActivity"
                            @keyup.enter="createActivityElement"
                            class="fira-sans-light w-full border rounded text-sm p-1"
                        >
                    </div>
                    <div class="mt-2 pl-2">
                        <div class="fira-sans-light my-1 flex flex-row space-x-2 border-b" v-for="activity in activityElements">
                            <div class="w-1/4">
                                <label>{{ activity.element.pActivity }}</label>
                            </div>
                            <div class="w-1/4">
                                <label>{{ activity.element.sActivity }}</label>
                            </div> 
                            <div class="w-1/4">
                                <select 
                                    @change="setActivityRelation(activity)"
                                    v-model="activity.element.relation"
                                    class="select w-full select-bordered font-secondary"
                                >
                                    <option
                                        v-for="relation in relationElements"
                                        :value="relation.element.symbol" 
                                        class="font-secondary"
                                        :selected="relation.element.symbol == '0' ? true : false"
                                    >
                                        {{ relation.element.description }}
                                    </option>
                                </select>

                            </div>
                            <div class="w-1/4">

                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="fira-sans-medium text-base">Manage Relations</h2>
                    <p class="firsa-sans-light py-1 text-xs">
                        This is where you specify your closeness ratings.
                    </p>
                    <button
                        class="bg-yellow-300 border text-xs p-1 mb-3 rounded-lg firsa-sans-light shadow"
                        @click="createRelationsForARC"
                    >
                        use Activity Relationship Chart Closeness Ratings
                    </button>

                    <form 
                        class="flex flex-row space-x-2"
                        @submit.prevent="createRelationElement"
                    >
                        <input
                            required
                            type="text"
                            placeholder="Relation symbol" 
                            v-model="newRelation.symbol"
                            class="fira-sans-light w-full border rounded text-sm p-1"
                        >
                        <input
                            required
                            type="text"
                            placeholder="Relation description" 
                            v-model="newRelation.description"
                            class="fira-sans-light w-full border rounded text-sm p-1"
                        >
                        <input type="submit" style="display: none" />
                    </form>
                    <div class="mt-2">
                        <div class="fira-sans-light" v-for="relation in relationElements">
                            <label>{{ relation.element.symbol }} - {{ relation.element.description }}</label>
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="fira-sans-medium text-base">Manage Causes</h2>
                    <form 
                        class="flex flex-row space-x-2"
                        @submit.prevent="createReasonElement"
                    >
                        <input
                            required
                            type="text"
                            placeholder="Reasoning symbol/id" 
                            v-model="newReason.symbol"
                            class="fira-sans-light w-full border rounded text-sm p-1"
                        >
                        <input
                            required
                            type="text"
                            placeholder="Reasoning description" 
                            v-model="newReason.description"
                            class="fira-sans-light w-full border rounded text-sm p-1"
                        >
                        <input type="submit" style="display: none" />
                    </form>
                    <div class="mt-2">
                        <div class="fira-sans-light"v-for="reason in reasonElements">
                            <label>{{ reason.element.symbol }} - {{ reason.element.description }}</label>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </body>

    <script>
        // localStorage.clear();
        var gun = new Gun(['https://gun-manhattan.herokuapp.com/gun']);

        // var gun = new Gun();
        var db = gun.get('wira-pratama-gunfps');

        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    elements: [],
                    activities: [],
                    relations: [],
                    reasons: [],
                    newMetadata: {
                        title: '',
                        subtitle: '',
                        author: '',
                        px: 40,
                        py: 20,
                        rh: 20,
                        rw: 120,
                        type: 'metadata'
                    },
                    newActivity: {
                        pActivity: '',
                        sActivity: '',
                        relation: '',
                        reason: '',
                        type: 'activity'
                    },
                    newRelation: {
                        symbol: '',
                        description: '',
                        type: 'relation'
                    },
                    newReason: {
                        symbol: '',
                        description: '',
                        type: 'reason'
                    },
                };
            },
            computed: {
                activityElements: function() {
                    /*
                        Find all activities that are paired (have sActivity)
                    */
                    var pairedActivityElements = this.elements.filter(function(element) {
                        return element.element.type === 'activity' && element.element.sActivity;
                    });

                    /*
                        This sorts activities based on pActivity
                    */
                    var sortedActivityElement = pairedActivityElements.sort(function(a,b) {
                        return a.element.pActivity.localeCompare(b.element.pActivity)
                    })

                    return sortedActivityElement;
                },
                relationElements: function() {
                    return this.elements.filter(function(element) {
                        return element.element.type === 'relation';
                    });
                },
                reasonElements: function() {
                    return this.elements.filter(function(element) {
                        return element.element.type === 'reason';
                    });
                },
            },
            methods: {
                generateGunfpId: function (prefix) {
                    return `${prefix}-` + Date.now() + '-' + Math.floor(Math.random() * 1000);
                },
                elementUpdated: function(element, nodeKey) {
                    /* 
                        Checks whether a node has the corrent id format and store it to local elements
                    */
                    if (!/^(activity-|relation-|reason-|metadata-)/.test(nodeKey)) {
                        return;
                    }
                    var existingElementIndex = this.elements.findIndex(function(element) {
                        return element.key === nodeKey
                    });
                    var elementToStore = {
                        element: element,
                        key: nodeKey
                    };
                    if (existingElementIndex === -1) {
                        this.elements.push(elementToStore);
                    } else {
                        this.elements.splice(existingElementIndex, 1, elementToStore);
                    };
                    console.log('test')
                    /*
                        If element does exist, check the type of the element and whether the item already indexed, if not push to local
                    */
                    if (/^(activity-)/.test(nodeKey)) {
                        var existingActivityIndex = this.activities.findIndex(function(activity) {
                            return activity === elementToStore.element.pActivity
                        });
                        if (existingActivityIndex === -1) {
                            this.activities.push(elementToStore.element.pActivity);
                        };
                    };
                    if (/^(relation-)/.test(nodeKey)) {
                        console.log('test')
                        var existingRelationIndex = this.relations.findIndex(function(relation) {
                            return relation === elementToStore.element.symbol
                        });
                        if (existingRelationIndex === -1) {
                            this.relations.push(elementToStore.element.symbol);
                        };
                    };
                    if (/^(reason-)/.test(nodeKey)) {
                        var existingReasonIndex = this.reasons.findIndex(function(reason) {
                            return reason === elementToStore.element.symbol
                        });
                        if (existingReasonIndex === -1) {
                            this.reasons.push(elementToStore.element.symbol);
                        };
                    };
                },
                createActivityElement: function() {
                    /* 
                        Check whether newActivity has been filled
                        TODO: Add warning to user
                    */
                    if (this.newActivity.pActivity === '') {
                        return;
                    }

                    /*
                        Check whether this element already exist in the activities index
                        TODO: Add warning to user
                    */
                    var newActivityName  = this.newActivity.pActivity;
                    var existingActivityIndex = this.activities.findIndex(function(activity) {
                        return activity === newActivityName;
                    });
                    if (existingActivityIndex !== -1) {
                        this.newActivity = {
                            pActivity: '',
                            sActivity: '',
                            relation: '',
                            reason: '',
                            type: 'activity'
                        };
                        return;
                    }

                    /*
                        Generate a new node based on an Id starting with 'activity' and store it to db
                    */
                    var id = this.generateGunfpId('activity')
                    var dbNewActivity = db.get(id);

                    dbNewActivity.put(this.newActivity);
                    db.set(dbNewActivity)
                    this.activities.push(this.newActivity.pActivity)

                    /*
                        Check whether the activities are more than one and generate a triangular combinations if so
                    */
                    if (this.activities.length > 1) {
                        for (
                            let i = 0; 
                            i < this.activities.length - 1; 
                            i++
                        ) {
                            var currentActivityIndex = this.activities.length - 1;

                            var id = this.generateGunfpId('activity')
                            var dbNewActivity = db.get(id);

                            dbNewActivity.put({
                                pActivity: this.activities[i],
                                sActivity: this.activities[currentActivityIndex],
                                weight: 0,
                                reason: 0,
                                type: 'activity'
                            });
                            db.set(dbNewActivity)
                        };
                    }

                    /*
                        Reset the field
                    */
                    this.newActivity = {
                        pActivity: '',
                        sActivity: '',
                        relation: '',
                        reason: '',
                        type: 'activity'
                    };
                },
                setActivityRelation: function(activity) {
                    /*
                        Set activity changes to gundb
                    */
                    db.get(activity.key).put({
                        relation: activity.element.relation
                    });
                },
                createRelationElement: function() {
                    /* 
                        Check whether newRelation has been filled
                        TODO: Add warning to user
                    */
                    if (
                        this.newRelation.symbol === '' ||
                        this.newRelation.description === ''
                    ) {
                        return;
                    }

                    /*
                        Check whether this element already exist in the relations index
                        TODO: Add warning to user
                    */
                    var newRelationSymbol  = this.newRelation.symbol;
                    var existingRelationIndex = this.relations.findIndex(function(relation) {
                        return relation === newRelationSymbol;
                    });
                    if (existingRelationIndex !== -1) {
                        this.newRelation = {
                            symbol: '',
                            description: '',
                            type: 'relation'
                        };
                        return;
                    }

                    /*
                        Generate a new node based on an Id starting with 'relation' and store it to db
                    */
                    var id = this.generateGunfpId('relation')
                    var newRelation = db.get(id);

                    newRelation.put(this.newRelation);
                    db.set(newRelation);
                    
                    /*
                        Reset the field
                    */
                    this.newRelation = {
                        symbol: '',
                        description: '',
                        type: 'relation'
                    };
                },
                createReasonElement: function() {
                    /* 
                        Check whether newRelation has been filled
                        TODO: Add warning to user
                    */
                    if (
                        this.newReason.symbol === '' ||
                        this.newReason.description === ''
                    ) {
                        return;
                    }

                    /*
                        Check whether this element already exist in the relations index
                        TODO: Add warning to user
                    */
                    var newReasonSymbol  = this.newReason.symbol;
                    var existingReasonIndex = this.reasons.findIndex(function(reason) {
                        return reason === newReasonSymbol;
                    });
                    if (existingReasonIndex !== -1) {
                        this.newReason = {
                            symbol: '',
                            description: '',
                            type: 'reason'
                        };
                        return;
                    }

                    /*
                        Generate a new node based on an Id starting with 'reason' and store it to db
                    */
                    var id = this.generateGunfpId('reason')
                    var newReason = db.get(id);

                    newReason.put(this.newReason);
                    db.set(newReason);
                    
                    /*
                        Reset the field
                    */
                    this.newReason = {
                        symbol: '',
                        description: '',
                        type: 'reason'
                    };
                },
                createRelationsForARC: function () {
                    const ARC_RELATIONS = [
                        {
                            symbol: '0',
                            description: 'Relation Not Set',
                            type: 'relation'
                        },
                        {
                            symbol: 'A',
                            description: 'Absolutely Necessary',
                            type: 'relation'
                        },
                        {
                            symbol: 'E',
                            description: 'Especially Important',
                            type: 'relation'
                        },
                        {
                            symbol: 'I',
                            description: 'Important',
                            type: 'relation'
                        },
                        {
                            symbol: 'O',
                            description: 'Ordinary Closeness',
                            type: 'relation'
                        },
                        {
                            symbol: 'U',
                            description: 'Unnecessary',
                            type: 'relation'
                        },
                        {
                            symbol: 'X',
                            description: 'Avoid Closeness',
                            type: 'relation'
                        },
                    ];

                    ARC_RELATIONS.forEach((arcRelation) => {
                        /*
                            Check whether this element already exist in the relations index
                            TODO: Add warning to user
                        */
                        var newReasonSymbol  = arcRelation.symbol;
                        var existingReasonIndex = this.reasons.findIndex(function(reason) {
                            return reason === newReasonSymbol;
                        });
                        if (existingReasonIndex !== -1) {
                            return;
                        }

                        /*
                            Generate a new node based on an Id starting with 'reason' and store it to db
                        */
                        var id = this.generateGunfpId('reason')
                        var newReason = db.get(id);

                        newReason.put(arcRelation);
                        db.set(newReason);
                        this.relations.push(arcRelation.symbol)
                    })
                }
            },
            mounted: function () {
                /*
                    Subscribe on the data
                */
                db.map().on(this.elementUpdated.bind(this));
            }
        }).mount("#app");
    </script>
</html>